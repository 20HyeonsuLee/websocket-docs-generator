<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket API Documentation</title>
    <link rel="stylesheet" th:href="@{/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>
</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p>API Î¨∏ÏÑúÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
    </div>
    
    <div id="error" class="error" style="display: none;">
        <h2>Ïò§Î•ò Î∞úÏÉù</h2>
        <p id="error-message"></p>
        <button onclick="location.reload()">Îã§Ïãú ÏãúÎèÑ</button>
    </div>

    <div id="app" class="container" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 id="api-title"></h1>
                    <div class="api-info">
                        <span id="api-version" class="version"></span>
                        <span id="asyncapi-version" class="asyncapi-version"></span>
                    </div>
                    <p id="api-description" class="description"></p>
                </div>
                <div>
                    <button id="header-collapse-all-btn" class="btn btn-secondary btn-sm" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">üìã Collapse All</button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="sidebar">
            <div id="nav-operations" class="nav-section">
                <h3>WebSocket Operations</h3>
                <ul class="nav-list" id="operations-nav-list">
                    <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê® -->
                </ul>
            </div>
            <div class="nav-section">
                <h3>DTO Schemas</h3>
                <ul class="nav-list">
                    <li><a href="#schemas">All Schemas</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3>WebSocket Test</h3>
                <ul class="nav-list">
                    <li><a href="#websocket-test">Connection Test</a></li>
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="content">
            <!-- Operations Section -->
            <section class="section">
                <div class="section-header">
                    <h2>WebSocket API Operations</h2>
                </div>
                <div id="operations-container">
                    <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê® -->
                </div>
            </section>

            <!-- WebSocket Test Section -->
            <section id="websocket-test" class="section">
                <h2>WebSocket Connection Test</h2>
                <div class="websocket-test-container">
                    <div class="connection-panel">
                        <h3>Connection Settings</h3>
                        <div class="connection-form">
                            <div class="form-group">
                                <label for="ws-url">WebSocket URL:</label>
                                <input type="text" id="ws-url" th:value="${websocketUrl}" placeholder="http://localhost:8080/ws">
                            </div>
                            <div class="connection-actions">
                                <button id="connect-btn" class="btn btn-primary">Connect</button>
                                <button id="disconnect-btn" class="btn btn-secondary" disabled>Disconnect</button>
                                <span id="connection-status" class="status-disconnected">Disconnected</span>
                            </div>
                        </div>
                    </div>

                    <div class="message-panel">
                        <h3>Send Message</h3>
                        <div class="message-form">
                            <div class="form-group">
                                <label for="message-destination">Destination:</label>
                                <select id="message-destination">
                                    <option value="">Select destination...</option>
                                </select>
                            </div>
                            <div id="destination-variables" class="destination-variables">
                                <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÎäî Î≥ÄÏàò ÏûÖÎ†• ÌïÑÎìúÎì§ -->
                            </div>
                            <div class="form-group">
                                <label for="final-destination">Final Destination:</label>
                                <input type="text" id="final-destination" readonly placeholder="Select destination first...">
                            </div>
                            <div class="form-group">
                                <label for="message-payload">Message Payload (JSON):</label>
                                <textarea id="message-payload" rows="6" placeholder='{"key": "value"}'></textarea>
                            </div>
                            <div class="message-actions">
                                <button id="send-message-btn" class="btn btn-primary" disabled>Send Message</button>
                                <button id="go-to-operation-btn" class="btn btn-info" disabled>Go to Operation</button>
                            </div>
                        </div>
                    </div>

                    <div class="subscription-panel">
                        <h3>Subscriptions</h3>
                        <div class="subscription-form">
                            <div class="form-group">
                                <label for="subscription-topic">Topic to Subscribe:</label>
                                <select id="subscription-topic">
                                    <option value="">Select topic...</option>
                                </select>
                            </div>
                            <div id="subscription-variables" class="destination-variables">
                                <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÎäî Î≥ÄÏàò ÏûÖÎ†• ÌïÑÎìúÎì§ -->
                            </div>
                            <div class="form-group">
                                <label for="final-subscription">Final Topic:</label>
                                <input type="text" id="final-subscription" readonly placeholder="Select topic first...">
                            </div>
                            <div class="subscription-actions">
                                <button id="subscribe-btn" class="btn btn-primary" disabled>Subscribe</button>
                                <button id="unsubscribe-all-btn" class="btn btn-secondary">Unsubscribe All</button>
                                <button id="go-to-topic-btn" class="btn btn-info" disabled>Go to Topic</button>
                            </div>
                        </div>
                        <div class="active-subscriptions">
                            <h4>Active Subscriptions:</h4>
                            <div id="subscriptions-list" class="subscriptions-list">
                                <div class="no-subscriptions">No active subscriptions</div>
                            </div>
                        </div>
                    </div>

                    <div class="log-panel">
                        <div class="log-header">
                            <h3>Connection & Send Log</h3>
                            <button id="clear-connection-log-btn" class="btn btn-secondary btn-sm">Clear</button>
                        </div>
                        <div id="message-log" class="message-log">
                            <div class="log-entry info">
                                <span class="timestamp">[--:--:--]</span>
                                <span class="message">Ready to connect...</span>
                            </div>
                        </div>
                    </div>

                    <div class="subscription-log-panel">
                        <div class="log-header">
                            <h3>Subscription Messages</h3>
                            <button id="clear-subscription-log-btn" class="btn btn-secondary btn-sm">Clear</button>
                        </div>
                        <div id="subscription-log" class="message-log">
                            <div class="log-entry info">
                                <span class="timestamp">[--:--:--]</span>
                                <span class="message">No active subscriptions</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- DTO Schemas Section -->
            <section id="schemas" class="section">
                <h2>DTO Schemas</h2>
                <div id="schemas-container">
                    <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê® -->
                </div>
            </section>
        </main>
    </div>

    <script th:inline="javascript">
        let apiSpec = null;

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadApiSpec();
                renderApiDocumentation();
                hideLoading();
                initializeNavigation();
            } catch (error) {
                showError('API Î™ÖÏÑ∏Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
            }
        });

        // AsyncAPI Î™ÖÏÑ∏ Î°úÎìú
        async function loadApiSpec() {
            // ThymeleafÎ°ú ÏÑúÎ≤ÑÏóêÏÑú Ï†ÑÎã¨Îêú YAML Îç∞Ïù¥ÌÑ∞ ÏßÅÏ†ë Ï£ºÏûÖ
            const yamlContent = /*[[${asyncApiYml}]]*/ '';
            console.log(yamlContent)
            apiSpec = jsyaml.load(yamlContent);
        }

        // API Î¨∏ÏÑú Î†åÎçîÎßÅ
        function renderApiDocumentation() {
            renderHeader();
            renderNavigation();
            renderOperations();
            renderSchemas();
            initializeWebSocketTest();
        }

        // Ìó§Îçî Î†åÎçîÎßÅ
        function renderHeader() {
            document.getElementById('api-title').textContent = apiSpec.info.title || 'WebSocket API';
            document.getElementById('api-version').textContent = `v${apiSpec.info.version}`;
            document.getElementById('asyncapi-version').textContent = `AsyncAPI ${apiSpec.asyncapi}`;
            document.getElementById('api-description').textContent = apiSpec.info.description || '';
        }

        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î†åÎçîÎßÅ
        function renderNavigation() {
            const operationsNav = document.getElementById('operations-nav-list');
            operationsNav.innerHTML = '';

            // Operations ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
            if (apiSpec.operations) {
                Object.keys(apiSpec.operations).forEach(operationPath => {
                    const operationId = 'operation-' + sanitizeId(operationPath);
                    const operationName = getOperationDisplayName(operationPath);
                    
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="#${operationId}">${operationName}</a>`;
                    operationsNav.appendChild(li);
                });
            }
        }


        // Operations Î†åÎçîÎßÅ
        function renderOperations() {
            const container = document.getElementById('operations-container');
            container.innerHTML = '';

            if (!apiSpec.operations) return;

            Object.entries(apiSpec.operations).forEach(([operationPath, operationSpec]) => {
                const operationId = 'operation-' + sanitizeId(operationPath);
                const operationCard = createOperationCard(operationId, operationPath, operationSpec);
                container.appendChild(operationCard);
            });
        }



        // Operation Ïπ¥Îìú ÏÉùÏÑ±
        function createOperationCard(operationId, operationPath, operationSpec) {
            const div = document.createElement('div');
            div.id = operationId;
            div.className = 'operation-card';

            const action = operationSpec.action || 'SEND';
            
            // Request Payload Ï†ïÎ≥¥ (send actionÏù∏ Í≤ΩÏö∞)
            let requestPayloadHtml = '';
            if (action === 'send') {
                requestPayloadHtml += '<div class="payload-section"><h4>üì§ Request</h4>';
                
                // Destination Ï†ïÎ≥¥Îäî Ìï≠ÏÉÅ ÌëúÏãú
                const destinationPath = getChannelPathFromRef(operationSpec.channel);
                
                if (operationSpec.messages && operationSpec.messages.length > 0) {
                    // Request payloadÍ∞Ä ÏûàÎäî Í≤ΩÏö∞
                    operationSpec.messages.forEach(messageRef => {
                        const messageName = getMessageNameFromRef(messageRef);
                        const messageSchema = getMessageSchema(messageName);
                        
                        requestPayloadHtml += `
                            <div class="payload-card">
                                <div class="payload-header">
                                    <strong>Destination:</strong> <code>${destinationPath}</code>
                                    ${generateDestinationVariablesInfo(destinationPath)}
                                </div>
                                <div class="payload-content">
                                    <h5>Payload Type: <code>${messageName}</code></h5>
                                    <div class="schema-tabs">
                                        <div class="tab-buttons">
                                            <button class="tab-button active" data-tab="example">Example</button>
                                            <button class="tab-button" data-tab="schema">Schema</button>
                                        </div>
                                        <div class="tab-content">
                                            <div class="tab-panel active" data-panel="example">
                                                <div class="schema-example">
                                                    <pre><code>${messageSchema}</code></pre>
                                                </div>
                                            </div>
                                            <div class="tab-panel" data-panel="schema">
                                                <div class="schema-tree">
                                                    ${generateSchemaTree(messageName)}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    // Request payloadÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ (Îπà Î©îÏãúÏßÄ)
                    requestPayloadHtml += `
                        <div class="payload-card">
                            <div class="payload-header">
                                <strong>Destination:</strong> <code>${destinationPath}</code>
                                ${generateDestinationVariablesInfo(destinationPath)}
                            </div>
                            <div class="payload-content">
                                <p>Ïù¥ ÏöîÏ≤≠ÏùÄ Îπà ÌéòÏù¥Î°úÎìúÎ•º Ï†ÑÏÜ°Ìï©ÎãàÎã§.</p>
                            </div>
                        </div>
                    `;
                }
                requestPayloadHtml += '</div>';
            }

            // Response Payload Ï†ïÎ≥¥
            let responsePayloadHtml = '';
            
            if (action === 'send' && operationSpec.reply) {
                // SEND Ïï°ÏÖò: replyÍ∞Ä ÏûàÎäî Í≤ΩÏö∞ Response ÌëúÏãú
                const replyChannelPath = getChannelPathFromRef(operationSpec.reply.channel);
                responsePayloadHtml += '<div class="payload-section"><h4>üì• Response</h4>';
                
                if (operationSpec.reply.messages && operationSpec.reply.messages.length > 0) {
                    operationSpec.reply.messages.forEach(messageRef => {
                        const messageName = getMessageNameFromRef(messageRef);
                        const messageSchema = getMessageSchema(messageName);
                        
                        responsePayloadHtml += `
                            <div class="payload-card">
                                <div class="payload-header">
                                    <strong>Subscribe to:</strong> <code>${replyChannelPath}</code>
                                    ${generateDestinationVariablesInfo(replyChannelPath)}
                                </div>
                                <div class="payload-content">
                                    <h5>Payload Type: <code>${messageName}</code></h5>
                                    <div class="schema-tabs">
                                        <div class="tab-buttons">
                                            <button class="tab-button active" data-tab="example">Example</button>
                                            <button class="tab-button" data-tab="schema">Schema</button>
                                        </div>
                                        <div class="tab-content">
                                            <div class="tab-panel active" data-panel="example">
                                                <div class="schema-example">
                                                    <pre><code>${messageSchema}</code></pre>
                                                </div>
                                            </div>
                                            <div class="tab-panel" data-panel="schema">
                                                <div class="schema-tree">
                                                    ${generateSchemaTree(messageName)}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                responsePayloadHtml += '</div>';
            } else if (action === 'receive' && operationSpec.messages && operationSpec.messages.length > 0) {
                // RECEIVE Ïï°ÏÖò: messagesÎ•º ResponseÎ°ú ÌëúÏãú
                const channelPath = getChannelPathFromRef(operationSpec.channel);
                responsePayloadHtml += '<div class="payload-section"><h4>üì• Received Message</h4>';
                
                operationSpec.messages.forEach(messageRef => {
                    const messageName = getMessageNameFromRef(messageRef);
                    const messageSchema = getMessageSchema(messageName);
                    
                    responsePayloadHtml += `
                        <div class="payload-card">
                            <div class="payload-header">
                                <strong>Subscribe to:</strong> <code>${channelPath}</code>
                                ${generateDestinationVariablesInfo(channelPath)}
                            </div>
                            <div class="payload-content">
                                <h5>Payload Type: <code>${messageName}</code></h5>
                                <div class="schema-tabs">
                                    <div class="tab-buttons">
                                        <button class="tab-button active" data-tab="example">Example</button>
                                        <button class="tab-button" data-tab="schema">Schema</button>
                                    </div>
                                    <div class="tab-content">
                                        <div class="tab-panel active" data-panel="example">
                                            <div class="schema-example">
                                                <pre><code>${messageSchema}</code></pre>
                                            </div>
                                        </div>
                                        <div class="tab-panel" data-panel="schema">
                                            <div class="schema-tree">
                                                ${generateSchemaTree(messageName)}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                responsePayloadHtml += '</div>';
            }

            div.innerHTML = `
                <div class="operation-header collapsible-header ${action.toLowerCase()}-header" onclick="toggleOperation('${operationId}')">
                    <div class="operation-header-content">
                        <span class="operation-badge ${action.toLowerCase()}">${action.toUpperCase()}</span>
                        <h3>${operationPath}</h3>
                    </div>
                    <span class="operation-toggle-icon">‚ñ∂</span>
                </div>
                <div class="operation-info collapsed">
                    <div class="operation-description">
                        <div class="operation-desc-content">
                            <p><strong>Summary:</strong> ${operationSpec.summary || 'ÏÑ§Î™Ö ÏóÜÏùå'}</p>
                            <p><strong>Description:</strong> ${operationSpec.description || 'ÏÉÅÏÑ∏ ÏÑ§Î™Ö ÏóÜÏùå'}</p>
                        </div>
                        <div class="operation-actions">
                            <button class="btn btn-info btn-sm go-to-test-btn" data-operation-path="${operationPath}" data-action="${action.toLowerCase()}">
                                üß™ Go to Test
                            </button>
                        </div>
                    </div>
                    ${requestPayloadHtml}
                    ${responsePayloadHtml}
                </div>
            `;

            return div;
        }

        // Schemas Î†åÎçîÎßÅ
        function renderSchemas() {
            const container = document.getElementById('schemas-container');
            container.innerHTML = '';

            if (!apiSpec.components || !apiSpec.components.schemas) return;

            Object.entries(apiSpec.components.schemas).forEach(([schemaName, schemaSpec]) => {
                const schemaCard = createSchemaCard(schemaName, schemaSpec);
                container.appendChild(schemaCard);
            });
        }

        // Schema Ïπ¥Îìú ÏÉùÏÑ±
        function createSchemaCard(schemaName, schemaSpec) {
            const div = document.createElement('div');
            div.id = `schema-${sanitizeId(schemaName)}`;
            div.className = 'schema-card';

            // Ïä§ÌÇ§Îßà ÏòàÏ†ú ÏÉùÏÑ±
            const schemaExample = generateSchemaExample(schemaSpec);
            const schemaTree = generateSchemaTreeForSchema(schemaSpec, schemaName);

            div.innerHTML = `
                <div class="schema-header collapsible-header" onclick="toggleSchemaCard('schema-${sanitizeId(schemaName)}')">
                    <div class="schema-header-content">
                        <h3>${schemaName}</h3>
                        <span class="schema-type-badge object-type">DTO</span>
                    </div>
                    <span class="schema-toggle-icon">‚ñ∂</span>
                </div>
                <div class="schema-content collapsed">
                    <div class="schema-tabs">
                        <div class="tab-buttons">
                            <button class="tab-button active" data-tab="example">Example</button>
                            <button class="tab-button" data-tab="schema">Schema</button>
                        </div>
                        <div class="tab-content">
                            <div class="tab-panel active" data-panel="example">
                                <div class="schema-example">
                                    <pre><code>${schemaExample}</code></pre>
                                </div>
                            </div>
                            <div class="tab-panel" data-panel="schema">
                                <div class="schema-tree">
                                    ${schemaTree}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return div;
        }

        // Ïä§ÌÇ§ÎßàÏö© Ìä∏Î¶¨ ÏÉùÏÑ±
        function generateSchemaTreeForSchema(schema, schemaName) {
            if (!schema.properties) return '<p>Ïä§ÌÇ§Îßà Ï†ïÎ≥¥ ÏóÜÏùå</p>';
            return generateSchemaTreeNode(schema, schemaName, 0);
        }

        // Î©îÏãúÏßÄ Ïä§ÌÇ§Îßà Í∞ÄÏ†∏Ïò§Í∏∞
        function getMessageSchema(messageName) {
            if (!apiSpec.components || !apiSpec.components.messages) return 'Ïä§ÌÇ§Îßà Ï†ïÎ≥¥ ÏóÜÏùå';
            
            const messageSpec = apiSpec.components.messages[messageName];
            if (!messageSpec || !messageSpec.payload || !messageSpec.payload.$ref) return 'Ïä§ÌÇ§Îßà Ï†ïÎ≥¥ ÏóÜÏùå';
            
            const schemaName = messageSpec.payload.$ref.split('/').pop();
            const schema = apiSpec.components.schemas[schemaName];
            
            if (!schema) return 'Ïä§ÌÇ§Îßà Ï†ïÎ≥¥ ÏóÜÏùå';
            
            return generateSchemaExample(schema);
        }

        // Ïä§ÌÇ§Îßà Ìä∏Î¶¨ ÏÉùÏÑ±
        function generateSchemaTree(messageName) {
            if (!apiSpec.components || !apiSpec.components.messages) return '<p>Ïä§ÌÇ§Îßà Ï†ïÎ≥¥ ÏóÜÏùå</p>';
            
            const messageSpec = apiSpec.components.messages[messageName];
            if (!messageSpec || !messageSpec.payload || !messageSpec.payload.$ref) return '<p>Ïä§ÌÇ§Îßà Ï†ïÎ≥¥ ÏóÜÏùå</p>';
            
            const schemaName = messageSpec.payload.$ref.split('/').pop();
            const schema = apiSpec.components.schemas[schemaName];
            
            if (!schema) return '<p>Ïä§ÌÇ§Îßà Ï†ïÎ≥¥ ÏóÜÏùå</p>';
            
            return generateSchemaTreeNode(schema, schemaName, 0);
        }

        // Ïä§ÌÇ§Îßà Ìä∏Î¶¨ ÎÖ∏Îìú ÏÉùÏÑ±
        function generateSchemaTreeNode(schema, nodeName, depth) {
            if (!schema.properties) return '';
            
            const indent = '  '.repeat(depth);
            let html = `<div class="schema-node" data-depth="${depth}">`;
            
            if (depth === 0) {
                html += `<div class="schema-node-header root-node">
                    <span class="schema-node-type object-type">${nodeName}</span>
                    <span class="schema-type-badge">object</span>
                </div>`;
            }
            
            html += '<div class="schema-node-children">';
            
            Object.entries(schema.properties).forEach(([propName, propSpec]) => {
                const isRequired = schema.required && schema.required.includes(propName);
                const fieldId = `field-${nodeName}-${propName}-${depth}`;
                
                html += `<div class="schema-field" data-field-id="${fieldId}">`;
                
                if (propSpec.type === 'object' && propSpec.properties) {
                    // Ï§ëÏ≤© Í∞ùÏ≤¥
                    html += `<div class="schema-node-header collapsible" data-field-id="${fieldId}">
                        <span class="toggle-icon">‚ñ∂</span>
                        <span class="schema-field-name">${propName}</span>
                        ${isRequired ? '<span class="required-badge">required</span>' : '<span class="optional-badge">optional</span>'}
                        <span class="schema-type-badge object-type">object</span>
                    </div>
                    <div class="schema-node-children collapsed" id="${fieldId}-children">
                        ${generateSchemaTreeNode(propSpec, `${nodeName}_${propName}`, depth + 1)}
                    </div>`;
                } else if (propSpec.type === 'array') {
                    // Î∞∞Ïó¥
                    html += `<div class="schema-node-header">
                        <span class="schema-field-name">${propName}</span>
                        ${isRequired ? '<span class="required-badge">required</span>' : '<span class="optional-badge">optional</span>'}
                        <span class="schema-type-badge array-type">array</span>
                    </div>`;
                    
                    if (propSpec.items && propSpec.items.type === 'object' && propSpec.items.properties) {
                        html += `<div class="schema-array-items">
                            <div class="schema-node-header collapsible" data-field-id="${fieldId}-items">
                                <span class="toggle-icon">‚ñ∂</span>
                                <span class="schema-field-name">items</span>
                                <span class="schema-type-badge object-type">object</span>
                            </div>
                            <div class="schema-node-children collapsed" id="${fieldId}-items-children">
                                ${generateSchemaTreeNode(propSpec.items, `${nodeName}_${propName}_item`, depth + 1)}
                            </div>
                        </div>`;
                    } else if (propSpec.items) {
                        html += `<div class="schema-array-items">
                            <div class="schema-field-info">
                                <span class="schema-field-name">items</span>
                                <span class="schema-type-badge">${propSpec.items.type || 'unknown'}</span>
                                ${propSpec.items.enum ? `<span class="enum-values">${propSpec.items.enum.join(' | ')}</span>` : ''}
                            </div>
                        </div>`;
                    }
                } else {
                    // Í∏∞Î≥∏ ÌÉÄÏûÖ
                    const typeClass = getTypeClass(propSpec.type);
                    html += `<div class="schema-node-header">
                        <span class="schema-field-name">${propName}</span>
                        ${isRequired ? '<span class="required-badge">required</span>' : '<span class="optional-badge">optional</span>'}
                        <span class="schema-type-badge ${typeClass}">${propSpec.type || 'unknown'}</span>
                        ${propSpec.enum ? generateEnumBadges(propSpec.enum) : ''}
                    </div>`;
                }
                
                html += '</div>';
            });
            
            html += '</div></div>';
            return html;
        }

        // Ïä§ÌÇ§Îßà ÏòàÏ†ú ÏÉùÏÑ±
        function generateSchemaExample(schema) {
            if (!schema.properties) return '{}';
            
            const example = generateExampleObject(schema);
            let jsonString = JSON.stringify(example, null, 2);
            
            // enum Í∞íÎì§Ïóê ÎåÄÌïú Ï£ºÏÑù Ï∂îÍ∞Ä
            jsonString = addEnumComments(jsonString, schema);
            return jsonString;
        }

        // enum Ï£ºÏÑù Ï∂îÍ∞Ä
        function addEnumComments(jsonString, schema) {
            if (!schema.properties) return jsonString;
            
            Object.entries(schema.properties).forEach(([propName, propSpec]) => {
                if (propSpec.type === 'string' && propSpec.enum && propSpec.enum.length > 1) {
                    // enum Í∞íÏù¥ ÏûàÎäî Î¨∏ÏûêÏó¥ ÌïÑÎìúÏóê Ï£ºÏÑù Ï∂îÍ∞Ä
                    const currentValue = propSpec.enum[0];
                    const enumComment = ` // ${propSpec.enum.join(' | ')}`;
                    const regex = new RegExp(`"${propName}":\\s*"${currentValue}"`, 'g');
                    jsonString = jsonString.replace(regex, `"${propName}": "${currentValue}"${enumComment}`);
                } else if (propSpec.type === 'object' && propSpec.properties) {
                    // Ï§ëÏ≤©Îêú Í∞ùÏ≤¥Ïóê ÎåÄÌï¥ÏÑúÎèÑ Ïû¨Í∑ÄÏ†ÅÏúºÎ°ú Ï≤òÎ¶¨
                    jsonString = addEnumComments(jsonString, propSpec);
                }
            });
            
            return jsonString;
        }

        // ÏòàÏ†ú Í∞ùÏ≤¥ ÏÉùÏÑ± (Ïû¨Í∑ÄÏ†ÅÏúºÎ°ú Ï§ëÏ≤© Í∞ùÏ≤¥ Ï≤òÎ¶¨)
        function generateExampleObject(schema) {
            if (!schema.properties) return {};
            
            const example = {};
            Object.entries(schema.properties).forEach(([propName, propSpec]) => {
                if (propSpec.type === 'string') {
                    if (propSpec.enum) {
                        example[propName] = propSpec.enum[0];
                    } else if (propSpec.const) {
                        example[propName] = propSpec.const;
                    } else {
                        example[propName] = `ÏòàÏãú ${propName}`;
                    }
                } else if (propSpec.type === 'integer') {
                    example[propName] = 1;
                } else if (propSpec.type === 'number') {
                    example[propName] = 1.0;
                } else if (propSpec.type === 'boolean') {
                    example[propName] = true;
                } else if (propSpec.type === 'array') {
                    if (propSpec.items) {
                        if (propSpec.items.type === 'object' && propSpec.items.properties) {
                            // Î∞∞Ïó¥ ÏïàÏùò Í∞ùÏ≤¥
                            example[propName] = [generateExampleObject(propSpec.items)];
                        } else if (propSpec.items.type === 'string') {
                            if (propSpec.items.enum) {
                                example[propName] = [propSpec.items.enum[0]];
                            } else if (propSpec.items.const) {
                                example[propName] = [propSpec.items.const];
                            } else {
                                example[propName] = [`ÏòàÏãú ${propName} item`];
                            }
                        } else {
                            example[propName] = [getDefaultValueForType(propSpec.items.type)];
                        }
                    } else {
                        example[propName] = [];
                    }
                } else if (propSpec.type === 'object' && propSpec.properties) {
                    // Ï§ëÏ≤©Îêú Í∞ùÏ≤¥Î•º Ïû¨Í∑ÄÏ†ÅÏúºÎ°ú ÏÉùÏÑ±
                    example[propName] = generateExampleObject(propSpec);
                } else {
                    example[propName] = getDefaultValueForType(propSpec.type);
                }
            });

            return example;
        }

        // ÌÉÄÏûÖÎ≥Ñ Í∏∞Î≥∏Í∞í Î∞òÌôò
        function getDefaultValueForType(type) {
            switch (type) {
                case 'string': return 'ÏòàÏãú Î¨∏ÏûêÏó¥';
                case 'integer': return 1;
                case 'number': return 1.0;
                case 'boolean': return true;
                case 'array': return [];
                case 'object': return {};
                default: return null;
            }
        }

        // ÌÉÄÏûÖÎ≥Ñ CSS ÌÅ¥ÎûòÏä§ Î∞òÌôò
        function getTypeClass(type) {
            switch (type) {
                case 'string': return 'string-type';
                case 'integer': return 'integer-type';
                case 'number': return 'number-type';
                case 'boolean': return 'boolean-type';
                case 'array': return 'array-type';
                case 'object': return 'object-type';
                default: return '';
            }
        }

        // ENUM Í∞íÎì§ÏùÑ Í∞úÎ≥Ñ Î∞∞ÏßÄÎ°ú ÏÉùÏÑ±
        function generateEnumBadges(enumValues) {
            return enumValues.map(value => 
                `<span class="enum-badge">${value}</span>`
            ).join('');
        }

        // Destination Variables Ï†ïÎ≥¥ ÏÉùÏÑ±
        function generateDestinationVariablesInfo(destinationPath) {
            if (!destinationPath) return '';
            
            // {Î≥ÄÏàòÎ™Ö} Ìå®ÌÑ¥ÏùÑ Ï∞æÍ∏∞
            const variables = destinationPath.match(/{([^}]+)}/g);
            
            if (!variables || variables.length === 0) return '';
            
            let variablesInfo = '<div class="destination-variables-info">';
            variablesInfo += '<div class="variables-label">Path Variables:</div>';
            variablesInfo += '<div class="variables-list">';
            
            variables.forEach(variable => {
                const varName = variable.slice(1, -1); // {} Ï†úÍ±∞
                const varDescription = getVariableDescription(varName);
                
                variablesInfo += `
                    <div class="variable-item">
                        <span class="variable-name">${varName}</span>
                        <span class="variable-desc">${varDescription}</span>
                    </div>
                `;
            });
            
            variablesInfo += '</div></div>';
            return variablesInfo;
        }

        // Î≥ÄÏàòÎ≥Ñ ÏÑ§Î™Ö ÏÉùÏÑ±
        function getVariableDescription(varName) {
            const descriptions = {
                'joinCode': 'Room join code (Î∞© Ï∞∏Í∞Ä ÏΩîÎìú)',
                'roomId': 'Room identifier (Î∞© ÏãùÎ≥ÑÏûê)',
                'userId': 'User identifier (ÏÇ¨Ïö©Ïûê ÏãùÎ≥ÑÏûê)',
                'playerId': 'Player identifier (ÌîåÎ†àÏù¥Ïñ¥ ÏãùÎ≥ÑÏûê)',
                'gameId': 'Game identifier (Í≤åÏûÑ ÏãùÎ≥ÑÏûê)',
                'sessionId': 'Session identifier (ÏÑ∏ÏÖò ÏãùÎ≥ÑÏûê)',
                'id': 'Resource identifier (Î¶¨ÏÜåÏä§ ÏãùÎ≥ÑÏûê)',
                'code': 'Access code (Ï†ëÍ∑º ÏΩîÎìú)',
                'token': 'Authentication token (Ïù∏Ï¶ù ÌÜ†ÌÅ∞)'
            };
            
            return descriptions[varName] || `${varName} parameter (${varName} Îß§Í∞úÎ≥ÄÏàò)`;
        }

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
        function sanitizeId(path) {
            return path.replace(/[^a-zA-Z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
        }

        function getChannelDisplayName(channelPath) {
            return channelPath.split('/').pop().replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function getOperationDisplayName(operationPath) {
            return operationPath.split('/').pop().replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function getMessageNameFromRef(messageRef) {
            if (typeof messageRef === 'string') return messageRef;
            if (messageRef.$ref) return messageRef.$ref.split('/').pop();
            return 'Unknown';
        }

        function getChannelPathFromRef(channelRef) {
            if (typeof channelRef === 'string') return channelRef;
            if (channelRef.$ref) {
                // #/channels/~1topic~1topic~1room~1{joinCode} ÌòïÌÉúÏóêÏÑú Ï±ÑÎÑê Í≤ΩÎ°ú Ï∂îÏ∂ú
                const refPath = channelRef.$ref.replace('#/channels/', '').replace(/~1/g, '/');
                return refPath;
            }
            return 'Unknown';
        }

        // UI ÏÉÅÌÉú Í¥ÄÎ¶¨
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').textContent = message;
            document.getElementById('error').style.display = 'block';
        }


        // Operation Ïπ¥Îìú ÌÜ†Í∏Ä
        function toggleOperation(operationId) {
            const content = document.querySelector(`#${operationId} .operation-info`);
            const toggleIcon = document.querySelector(`#${operationId} .operation-toggle-icon`);
            
            if (content && toggleIcon) {
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    toggleIcon.textContent = '‚ñº';
                } else {
                    content.classList.add('collapsed');
                    toggleIcon.textContent = '‚ñ∂';
                }
            }
        }

        // Schema Ïπ¥Îìú ÌÜ†Í∏Ä
        function toggleSchemaCard(schemaId) {
            const content = document.querySelector(`#${schemaId} .schema-content`);
            const toggleIcon = document.querySelector(`#${schemaId} .schema-toggle-icon`);
            
            if (content && toggleIcon) {
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    toggleIcon.textContent = '‚ñº';
                } else {
                    content.classList.add('collapsed');
                    toggleIcon.textContent = '‚ñ∂';
                }
            }
        }

        // ÌÉ≠ Ï†ÑÌôò Î∞è Ïä§ÌÇ§Îßà ÎÖ∏Îìú ÌÜ†Í∏Ä (Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ ÏÇ¨Ïö©)
        function initializeTabs() {
            document.addEventListener('click', function(e) {
                // ÌÉ≠ Î≤ÑÌäº ÌÅ¥Î¶≠ Ï≤òÎ¶¨
                if (e.target.classList.contains('tab-button')) {
                    const tab = e.target.dataset.tab;
                    const tabContainer = e.target.closest('.schema-tabs');
                    
                    // ÌÉ≠ Î≤ÑÌäº ÌôúÏÑ±Ìôî
                    tabContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // ÌÉ≠ Ìå®ÎÑê ÌëúÏãú
                    tabContainer.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                    tabContainer.querySelector(`[data-panel="${tab}"]`).classList.add('active');
                }
                
                // Ïä§ÌÇ§Îßà ÎÖ∏Îìú ÌÜ†Í∏Ä ÌÅ¥Î¶≠ Ï≤òÎ¶¨ (Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ)
                if (e.target.closest('.collapsible')) {
                    const header = e.target.closest('.collapsible');
                    const fieldId = header.getAttribute('data-field-id');
                    if (fieldId) {
                        toggleSchemaNodeByElement(header);
                    }
                }
            });
        }

        // ÏöîÏÜå Í∏∞Î∞ò Ïä§ÌÇ§Îßà ÎÖ∏Îìú ÌÜ†Í∏Ä
        function toggleSchemaNodeByElement(headerElement) {
            const fieldId = headerElement.getAttribute('data-field-id');
            const toggleIcon = headerElement.querySelector('.toggle-icon');
            
            // ÌÅ¥Î¶≠Ìïú Ìó§Îçî Î∞îÎ°ú Îã§ÏùåÏóê ÏûàÎäî children Ï∞æÍ∏∞
            let targetChildren = null;
            
            // Ìó§ÎçîÏùò Îã§Ïùå ÌòïÏ†ú ÏöîÏÜåÏóêÏÑú schema-node-children Ï∞æÍ∏∞
            let nextElement = headerElement.nextElementSibling;
            while (nextElement) {
                if (nextElement.classList.contains('schema-node-children')) {
                    targetChildren = nextElement;
                    break;
                }
                nextElement = nextElement.nextElementSibling;
            }
            
            // Î™ª Ï∞æÏïòÏúºÎ©¥ IDÎ°ú Îã§Ïãú ÏãúÎèÑ
            if (!targetChildren) {
                targetChildren = document.getElementById(`${fieldId}-items-children`) || 
                                document.getElementById(`${fieldId}-children`);
            }
            
            console.log('Field ID:', fieldId, 'Target children:', targetChildren); // ÎîîÎ≤ÑÍπÖÏö©
            
            if (targetChildren && toggleIcon) {
                if (targetChildren.classList.contains('collapsed')) {
                    targetChildren.classList.remove('collapsed');
                    toggleIcon.textContent = '‚ñº';
                    console.log('Expanded'); // ÎîîÎ≤ÑÍπÖÏö©
                } else {
                    targetChildren.classList.add('collapsed');
                    toggleIcon.textContent = '‚ñ∂';
                    console.log('Collapsed'); // ÎîîÎ≤ÑÍπÖÏö©
                }
            } else {
                console.log('Target children or toggle icon not found'); // ÎîîÎ≤ÑÍπÖÏö©
            }
        }

        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ï¥àÍ∏∞Ìôî
        function initializeNavigation() {
            // ÌÉ≠ Ï¥àÍ∏∞Ìôî
            initializeTabs();
            
            // Collapse All Î≤ÑÌäº Ïù¥Î≤§Ìä∏
            document.getElementById('header-collapse-all-btn').addEventListener('click', collapseAllOperations);
            
            // Go to Test Î≤ÑÌäºÎì§ Ïù¥Î≤§Ìä∏ (Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ)
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('go-to-test-btn')) {
                    const operationPath = e.target.getAttribute('data-operation-path');
                    const action = e.target.getAttribute('data-action');
                    goToTestFromOperation(operationPath, action);
                }
            });
            
            // Smooth scrolling for navigation links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });

            // Highlight current section in navigation
            window.addEventListener('scroll', () => {
                let current = '';
                document.querySelectorAll('section[id], [id^="channel-"], [id^="operation-"]').forEach(section => {
                    const sectionTop = section.offsetTop;
                    if (window.pageYOffset >= sectionTop - 60) {
                        current = section.getAttribute('id');
                    }
                });

                document.querySelectorAll('.nav-list a').forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === `#${current}`) {
                        link.classList.add('active');
                    }
                });
            });
        }

        // WebSocket Test Í∏∞Îä•
        let stompClient = null;
        let subscriptions = [];

        function initializeWebSocketTest() {
            populateDestinations();
            populateSubscriptionTopics();
            initializeWebSocketEvents();
        }

        function populateDestinations() {
            const destinationSelect = document.getElementById('message-destination');
            destinationSelect.innerHTML = '<option value="">Select destination...</option>';
            
            if (apiSpec.operations) {
                Object.entries(apiSpec.operations).forEach(([operationPath, operationSpec]) => {
                    if (operationSpec.action === 'send') {
                        const channelPath = getChannelPathFromRef(operationSpec.channel);
                        const option = document.createElement('option');
                        option.value = channelPath;
                        // Ï§ëÎ≥µÎêòÍ±∞ÎÇò Ïú†ÏÇ¨Ìïú Í≤ΩÏö∞ channelPathÎßå ÌëúÏãú, Îã§Î•∏ Í≤ΩÏö∞ operationPath ÌëúÏãú
                        if (operationPath === channelPath || channelPath.includes(operationPath)) {
                            option.textContent = channelPath;
                        } else {
                            option.textContent = `${operationPath} (${channelPath})`;
                        }
                        destinationSelect.appendChild(option);
                    }
                });
            }
        }

        function populateSubscriptionTopics() {
            const topicSelect = document.getElementById('subscription-topic');
            topicSelect.innerHTML = '<option value="">Select topic...</option>';
            
            const topics = new Set(); // Ï§ëÎ≥µ Ï†úÍ±∞
            
            if (apiSpec.operations) {
                Object.entries(apiSpec.operations).forEach(([operationPath, operationSpec]) => {
                    // RECEIVE Ïò§ÌçºÎ†àÏù¥ÏÖòÏùò Ï±ÑÎÑê
                    if (operationSpec.action === 'receive') {
                        const topicPath = getChannelPathFromRef(operationSpec.channel);
                        topics.add(topicPath);
                    }
                    
                    // SEND Ïò§ÌçºÎ†àÏù¥ÏÖòÏùò reply Ï±ÑÎÑê
                    if (operationSpec.action === 'send' && operationSpec.reply) {
                        const replyPath = getChannelPathFromRef(operationSpec.reply.channel);
                        topics.add(replyPath);
                    }
                });
            }
            
            topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                topicSelect.appendChild(option);
            });
        }

        function initializeWebSocketEvents() {
            document.getElementById('connect-btn').addEventListener('click', connectWebSocket);
            document.getElementById('disconnect-btn').addEventListener('click', disconnectWebSocket);
            document.getElementById('send-message-btn').addEventListener('click', sendMessage);
            
            // Íµ¨ÎèÖ Í¥ÄÎ†® Ïù¥Î≤§Ìä∏
            document.getElementById('subscribe-btn').addEventListener('click', manualSubscribe);
            document.getElementById('unsubscribe-all-btn').addEventListener('click', unsubscribeAll);
            
            // Î°úÍ∑∏ ÌÅ¥Î¶¨Ïñ¥ Ïù¥Î≤§Ìä∏
            document.getElementById('clear-connection-log-btn').addEventListener('click', clearConnectionLog);
            document.getElementById('clear-subscription-log-btn').addEventListener('click', clearSubscriptionLog);
            
            // Operation Ïù¥Îèô Ïù¥Î≤§Ìä∏
            document.getElementById('go-to-operation-btn').addEventListener('click', goToOperation);
            document.getElementById('go-to-topic-btn').addEventListener('click', goToTopic);
            
            // Destination ÏÑ†ÌÉù Ïãú ÏòàÏ†ú Î©îÏãúÏßÄ Î°úÎìú
            document.getElementById('message-destination').addEventListener('change', function(e) {
                const selectedPath = e.target.value;
                createDestinationVariableInputs(selectedPath);
                loadExampleMessage(selectedPath);
                updateFinalDestination();
                updateGoToOperationButton();
            });
            
            // Íµ¨ÎèÖ ÌÜ†ÌîΩ ÏÑ†ÌÉù Ïãú Î≥ÄÏàò ÏûÖÎ†• ÌïÑÎìú ÏÉùÏÑ±
            document.getElementById('subscription-topic').addEventListener('change', function(e) {
                const selectedTopic = e.target.value;
                createSubscriptionVariableInputs(selectedTopic);
                updateFinalSubscription();
                updateGoToTopicButton();
            });
        }

        function connectWebSocket() {
            const url = document.getElementById('ws-url').value.trim();
            if (!url) {
                addLogEntry('error', 'Please enter a WebSocket URL');
                return;
            }

            try {
                addLogEntry('info', `Connecting to ${url}...`);
                
                // SockJSÏôÄ STOMP Ïó∞Í≤∞
                const socket = new SockJS(url);
                stompClient = StompJs.Stomp.over(socket);
                
                // STOMP Ïó∞Í≤∞
                stompClient.connect({}, function(frame) {
                    addLogEntry('success', `STOMP connected to ${url}`);
                    addLogEntry('info', `Session: ${frame.headers['session']}`);
                    updateConnectionStatus(true);
                    
                }, function(error) {
                    addLogEntry('error', `STOMP connection failed: ${error}`);
                    updateConnectionStatus(false);
                });

                // WebSocket Ïó∞Í≤∞ ÏÉÅÌÉú Î™®ÎãàÌÑ∞ÎßÅ
                socket.onopen = function() {
                    addLogEntry('info', 'SockJS connection opened');
                };

                socket.onclose = function(event) {
                    addLogEntry('info', `SockJS connection closed (code: ${event.code})`);
                    updateConnectionStatus(false);
                    clearSubscriptions();
                };

                socket.onerror = function(error) {
                    addLogEntry('error', `SockJS error: ${error}`);
                };
                
            } catch (error) {
                addLogEntry('error', `Connection failed: ${error.message}`);
                updateConnectionStatus(false);
            }
        }

        function disconnectWebSocket() {
            if (stompClient && stompClient.connected) {
                // Î™®Îì† Íµ¨ÎèÖ Ìï¥Ï†ú
                clearSubscriptions();
                
                // STOMP Ïó∞Í≤∞ Ìï¥Ï†ú
                stompClient.disconnect(function() {
                    addLogEntry('info', 'STOMP disconnected');
                    updateConnectionStatus(false);
                });
            } else {
                updateConnectionStatus(false);
                addLogEntry('info', 'Already disconnected');
            }
        }

        function createSubscriptionVariableInputs(topicPath) {
            const variablesContainer = document.getElementById('subscription-variables');
            variablesContainer.innerHTML = '';

            if (!topicPath) return;

            // {Î≥ÄÏàòÎ™Ö} Ìå®ÌÑ¥ÏùÑ Ï∞æÏïÑÏÑú ÏûÖÎ†• ÌïÑÎìú ÏÉùÏÑ±
            const variables = topicPath.match(/{([^}]+)}/g);
            
            if (variables && variables.length > 0) {
                variables.forEach(variable => {
                    const varName = variable.slice(1, -1); // {} Ï†úÍ±∞
                    
                    const formGroup = document.createElement('div');
                    formGroup.className = 'form-group';
                    
                    formGroup.innerHTML = `
                        <label for="sub-var-${varName}">${varName}:</label>
                        <input type="text" id="sub-var-${varName}" data-variable="${varName}" 
                               placeholder="Enter ${varName}..." class="subscription-variable">
                    `;
                    
                    variablesContainer.appendChild(formGroup);
                });

                // Î≥ÄÏàò ÏûÖÎ†• Ïãú ÏµúÏ¢Ö subscription ÏóÖÎç∞Ïù¥Ìä∏
                variablesContainer.addEventListener('input', updateFinalSubscription);
            }
        }

        function updateFinalSubscription() {
            const baseTopic = document.getElementById('subscription-topic').value;
            const finalSubscriptionInput = document.getElementById('final-subscription');
            const subscribeBtn = document.getElementById('subscribe-btn');
            
            if (!baseTopic) {
                finalSubscriptionInput.value = '';
                subscribeBtn.disabled = true;
                return;
            }

            let finalTopic = baseTopic;
            
            // Î™®Îì† Î≥ÄÏàò ÏûÖÎ†• ÌïÑÎìúÏùò Í∞íÏúºÎ°ú ÏπòÌôò
            const variableInputs = document.querySelectorAll('.subscription-variable');
            variableInputs.forEach(input => {
                const varName = input.dataset.variable;
                const varValue = input.value.trim();
                if (varValue) {
                    finalTopic = finalTopic.replace(`{${varName}}`, varValue);
                }
            });
            
            finalSubscriptionInput.value = finalTopic;
            
            // Î≥ÄÏàòÍ∞Ä Î™®Îëê Ï±ÑÏõåÏ°åÎäîÏßÄ ÌôïÏù∏
            const hasUnfilledVariables = finalTopic.includes('{') && finalTopic.includes('}');
            subscribeBtn.disabled = !stompClient || !stompClient.connected || hasUnfilledVariables;
        }

        function manualSubscribe() {
            if (!stompClient || !stompClient.connected) {
                addLogEntry('error', 'Not connected to STOMP server');
                return;
            }

            const finalTopic = document.getElementById('final-subscription').value;
            
            if (!finalTopic) {
                addLogEntry('error', 'Please select a topic');
                return;
            }

            // Î≥ÄÏàòÍ∞Ä ÏïÑÏßÅ ÏπòÌôòÎêòÏßÄ ÏïäÏïòÎäîÏßÄ ÌôïÏù∏
            if (finalTopic.includes('{') && finalTopic.includes('}')) {
                addLogEntry('error', 'Please fill in all topic variables');
                return;
            }

            // Ïù¥ÎØ∏ Íµ¨ÎèÖ Ï§ëÏù∏ÏßÄ ÌôïÏù∏
            const existingSubscription = subscriptions.find(sub => sub.destination === finalTopic);
            if (existingSubscription) {
                addLogEntry('error', `Already subscribed to ${finalTopic}`);
                return;
            }

            subscribeToTopic(finalTopic);
            updateSubscriptionsList();
        }

        function unsubscribeAll() {
            clearSubscriptions();
            updateSubscriptionsList();
            addLogEntry('info', 'All subscriptions cleared');
            
            // Íµ¨ÎèÖ Î°úÍ∑∏ÎèÑ Ï¥àÍ∏∞Ìôî
            const subscriptionLogContainer = document.getElementById('subscription-log');
            subscriptionLogContainer.innerHTML = `
                <div class="log-entry info">
                    <span class="timestamp">[${new Date().toLocaleTimeString()}]</span>
                    <span class="message">No active subscriptions</span>
                </div>
            `;
        }

        function subscribeToTopic(topicPath) {
            if (!stompClient || !stompClient.connected) return;
            
            // Ïù¥ÎØ∏ Íµ¨ÎèÖ Ï§ëÏù∏ÏßÄ ÌôïÏù∏
            const existingSubscription = subscriptions.find(sub => sub.destination === topicPath);
            if (existingSubscription) return;
            
            try {
                const subscription = stompClient.subscribe(topicPath, function(message) {
                    addSubscriptionLogEntry('received', topicPath, message.body);
                });
                
                subscriptions.push({
                    destination: topicPath,
                    subscription: subscription
                });
                
                addLogEntry('info', `Subscribed to ${topicPath}`);
                
                // Ï≤´ Î≤àÏß∏ Íµ¨ÎèÖ Ïãú subscription log Ï¥àÍ∏∞Ìôî
                if (subscriptions.length === 1) {
                    clearSubscriptionLog();
                }
            } catch (error) {
                addLogEntry('error', `Failed to subscribe to ${topicPath}: ${error.message}`);
            }
        }

        function updateSubscriptionsList() {
            const subscriptionsList = document.getElementById('subscriptions-list');
            
            if (subscriptions.length === 0) {
                subscriptionsList.innerHTML = '<div class="no-subscriptions">No active subscriptions</div>';
                return;
            }
            
            subscriptionsList.innerHTML = '';
            subscriptions.forEach(sub => {
                const subscriptionItem = document.createElement('div');
                subscriptionItem.className = 'subscription-item';
                
                subscriptionItem.innerHTML = `
                    <span class="subscription-topic">${sub.destination}</span>
                    <button class="unsubscribe-btn" onclick="unsubscribeFromTopic('${sub.destination}')">√ó</button>
                `;
                
                subscriptionsList.appendChild(subscriptionItem);
            });
        }

        function unsubscribeFromTopic(topicPath) {
            const subscriptionIndex = subscriptions.findIndex(sub => sub.destination === topicPath);
            if (subscriptionIndex === -1) return;
            
            try {
                subscriptions[subscriptionIndex].subscription.unsubscribe();
                subscriptions.splice(subscriptionIndex, 1);
                updateSubscriptionsList();
                addLogEntry('info', `Unsubscribed from ${topicPath}`);
            } catch (error) {
                addLogEntry('error', `Failed to unsubscribe from ${topicPath}: ${error.message}`);
            }
        }

        function clearSubscriptions() {
            subscriptions.forEach(sub => {
                try {
                    sub.subscription.unsubscribe();
                } catch (error) {
                    console.error('Error unsubscribing:', error);
                }
            });
            subscriptions = [];
        }

        function createDestinationVariableInputs(destinationPath) {
            const variablesContainer = document.getElementById('destination-variables');
            variablesContainer.innerHTML = '';

            if (!destinationPath) return;

            // {Î≥ÄÏàòÎ™Ö} Ìå®ÌÑ¥ÏùÑ Ï∞æÏïÑÏÑú ÏûÖÎ†• ÌïÑÎìú ÏÉùÏÑ±
            const variables = destinationPath.match(/{([^}]+)}/g);
            
            if (variables && variables.length > 0) {
                variables.forEach(variable => {
                    const varName = variable.slice(1, -1); // {} Ï†úÍ±∞
                    
                    const formGroup = document.createElement('div');
                    formGroup.className = 'form-group';
                    
                    formGroup.innerHTML = `
                        <label for="var-${varName}">${varName}:</label>
                        <input type="text" id="var-${varName}" data-variable="${varName}" 
                               placeholder="Enter ${varName}..." class="destination-variable">
                    `;
                    
                    variablesContainer.appendChild(formGroup);
                });

                // Î≥ÄÏàò ÏûÖÎ†• Ïãú ÏµúÏ¢Ö destination ÏóÖÎç∞Ïù¥Ìä∏
                variablesContainer.addEventListener('input', updateFinalDestination);
            }
        }

        function updateFinalDestination() {
            const baseDestination = document.getElementById('message-destination').value;
            const finalDestinationInput = document.getElementById('final-destination');
            
            if (!baseDestination) {
                finalDestinationInput.value = '';
                return;
            }

            let finalDestination = baseDestination;
            
            // Î™®Îì† Î≥ÄÏàò ÏûÖÎ†• ÌïÑÎìúÏùò Í∞íÏúºÎ°ú ÏπòÌôò
            const variableInputs = document.querySelectorAll('.destination-variable');
            variableInputs.forEach(input => {
                const varName = input.dataset.variable;
                const varValue = input.value.trim();
                if (varValue) {
                    finalDestination = finalDestination.replace(`{${varName}}`, varValue);
                }
            });
            
            finalDestinationInput.value = finalDestination;
        }

        function sendMessage() {
            if (!stompClient || !stompClient.connected) {
                addLogEntry('error', 'Not connected to STOMP server');
                return;
            }

            const finalDestination = document.getElementById('final-destination').value;
            const payload = document.getElementById('message-payload').value.trim();

            if (!finalDestination) {
                addLogEntry('error', 'Please select a destination');
                return;
            }

            // Î≥ÄÏàòÍ∞Ä ÏïÑÏßÅ ÏπòÌôòÎêòÏßÄ ÏïäÏïòÎäîÏßÄ ÌôïÏù∏
            if (finalDestination.includes('{') && finalDestination.includes('}')) {
                addLogEntry('error', 'Please fill in all destination variables');
                return;
            }

            try {
                let messageBody = {};
                if (payload) {
                    // JSON validation
                    messageBody = JSON.parse(payload);
                }

                // STOMP send
                stompClient.send(finalDestination, {
                    'content-type': 'application/json'
                }, JSON.stringify(messageBody));
                
                addLogEntry('sent', `Sent to ${finalDestination}: ${JSON.stringify(messageBody)}`);
                
            } catch (error) {
                if (error.name === 'SyntaxError') {
                    addLogEntry('error', `Invalid JSON payload: ${error.message}`);
                } else {
                    addLogEntry('error', `Failed to send message: ${error.message}`);
                }
            }
        }

        function loadExampleMessage(destination) {
            if (!destination || !apiSpec.operations) return;
            
            // Ìï¥Îãπ destinationÍ≥º Îß§Ïπ≠ÎêòÎäî operation Ï∞æÍ∏∞
            Object.entries(apiSpec.operations).forEach(([operationPath, operationSpec]) => {
                if (operationSpec.action === 'send' && getChannelPathFromRef(operationSpec.channel) === destination) {
                    if (operationSpec.messages && operationSpec.messages.length > 0) {
                        const messageName = getMessageNameFromRef(operationSpec.messages[0]);
                        const exampleJson = getMessageSchema(messageName);
                        document.getElementById('message-payload').value = exampleJson;
                    } else {
                        document.getElementById('message-payload').value = '{}';
                    }
                }
            });
        }

        function updateConnectionStatus(isConnected) {
            const statusElement = document.getElementById('connection-status');
            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');
            const sendBtn = document.getElementById('send-message-btn');

            if (isConnected && stompClient && stompClient.connected) {
                statusElement.textContent = 'Connected (STOMP)';
                statusElement.className = 'status-connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendBtn.disabled = false;
            } else {
                statusElement.textContent = 'Disconnected';
                statusElement.className = 'status-disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendBtn.disabled = true;
            }
        }

        function addLogEntry(type, message) {
            const logContainer = document.getElementById('message-log');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `
                <span class="timestamp">[${timestamp}]</span>
                <span class="message">${message}</span>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function addSubscriptionLogEntry(type, topic, message) {
            const logContainer = document.getElementById('subscription-log');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            // JSON Î©îÏãúÏßÄÎ•º ÏòàÏÅòÍ≤å Ìè¨Îß∑ÌåÖ
            let formattedMessage = message;
            try {
                const jsonObj = JSON.parse(message);
                formattedMessage = JSON.stringify(jsonObj, null, 2);
            } catch (e) {
                // JSONÏù¥ ÏïÑÎãàÎ©¥ Í∑∏ÎåÄÎ°ú ÌëúÏãú
            }
            
            logEntry.innerHTML = `
                <span class="timestamp">[${timestamp}]</span>
                <div class="subscription-message">
                    <div class="subscription-topic-header">${topic}</div>
                    <pre class="subscription-content">${formattedMessage}</pre>
                </div>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearSubscriptionLog() {
            const logContainer = document.getElementById('subscription-log');
            logContainer.innerHTML = `
                <div class="log-entry info">
                    <span class="timestamp">[${new Date().toLocaleTimeString()}]</span>
                    <span class="message">Waiting for subscription messages...</span>
                </div>
            `;
        }

        function clearConnectionLog() {
            const logContainer = document.getElementById('message-log');
            logContainer.innerHTML = `
                <div class="log-entry info">
                    <span class="timestamp">[${new Date().toLocaleTimeString()}]</span>
                    <span class="message">Connection log cleared</span>
                </div>
            `;
        }

        function goToOperation() {
            const selectedDestination = document.getElementById('message-destination').value;
            if (!selectedDestination) return;
            
            // AsyncAPI Î™ÖÏÑ∏ÏóêÏÑú Ìï¥Îãπ destinationÍ≥º Îß§Ïπ≠ÎêòÎäî operation Ï∞æÍ∏∞
            if (apiSpec.operations) {
                Object.entries(apiSpec.operations).forEach(([operationPath, operationSpec]) => {
                    if (operationSpec.action === 'send' && getChannelPathFromRef(operationSpec.channel) === selectedDestination) {
                        const operationId = 'operation-' + sanitizeId(operationPath);
                        const operationElement = document.getElementById(operationId);
                        if (operationElement) {
                            // Ìï¥Îãπ operationÏúºÎ°ú Ïä§ÌÅ¨Î°§
                            operationElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            
                            // operationÏù¥ Ï†ëÌòÄÏûàÏúºÎ©¥ ÌéºÏπòÍ∏∞
                            const operationInfo = operationElement.querySelector('.operation-info');
                            const toggleIcon = operationElement.querySelector('.operation-toggle-icon');
                            if (operationInfo && operationInfo.classList.contains('collapsed')) {
                                operationInfo.classList.remove('collapsed');
                                toggleIcon.textContent = '‚ñº';
                            }
                            
                            // Ïû†Íπê ÌïòÏù¥ÎùºÏù¥Ìä∏ Ìö®Í≥º
                            operationElement.style.boxShadow = '0 0 20px rgba(52, 152, 219, 0.6)';
                            setTimeout(() => {
                                operationElement.style.boxShadow = '';
                            }, 2000);
                        }
                    }
                });
            }
        }

        function goToTopic() {
            const selectedTopic = document.getElementById('subscription-topic').value;
            if (!selectedTopic) return;
            
            // AsyncAPI Î™ÖÏÑ∏ÏóêÏÑú Ìï¥Îãπ topicÍ≥º Îß§Ïπ≠ÎêòÎäî operation Ï∞æÍ∏∞
            if (apiSpec.operations) {
                Object.entries(apiSpec.operations).forEach(([operationPath, operationSpec]) => {
                    let topicPath = '';
                    
                    if (operationSpec.action === 'receive' && getChannelPathFromRef(operationSpec.channel) === selectedTopic) {
                        topicPath = operationPath;
                    } else if (operationSpec.action === 'send' && operationSpec.reply && getChannelPathFromRef(operationSpec.reply.channel) === selectedTopic) {
                        topicPath = operationPath;
                    }
                    
                    if (topicPath) {
                        const operationId = 'operation-' + sanitizeId(topicPath);
                        const operationElement = document.getElementById(operationId);
                        if (operationElement) {
                            // Ìï¥Îãπ operationÏúºÎ°ú Ïä§ÌÅ¨Î°§
                            operationElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            
                            // operationÏù¥ Ï†ëÌòÄÏûàÏúºÎ©¥ ÌéºÏπòÍ∏∞
                            const operationInfo = operationElement.querySelector('.operation-info');
                            const toggleIcon = operationElement.querySelector('.operation-toggle-icon');
                            if (operationInfo && operationInfo.classList.contains('collapsed')) {
                                operationInfo.classList.remove('collapsed');
                                toggleIcon.textContent = '‚ñº';
                            }
                            
                            // Ïû†Íπê ÌïòÏù¥ÎùºÏù¥Ìä∏ Ìö®Í≥º
                            operationElement.style.boxShadow = '0 0 20px rgba(23, 162, 184, 0.6)';
                            setTimeout(() => {
                                operationElement.style.boxShadow = '';
                            }, 2000);
                        }
                    }
                });
            }
        }

        function updateGoToOperationButton() {
            const goToOperationBtn = document.getElementById('go-to-operation-btn');
            const selectedDestination = document.getElementById('message-destination').value;
            goToOperationBtn.disabled = !selectedDestination;
        }

        function updateGoToTopicButton() {
            const goToTopicBtn = document.getElementById('go-to-topic-btn');
            const selectedTopic = document.getElementById('subscription-topic').value;
            goToTopicBtn.disabled = !selectedTopic;
        }

        function collapseAllOperations() {
            const allOperationInfos = document.querySelectorAll('.operation-info');
            const allToggleIcons = document.querySelectorAll('.operation-toggle-icon');
            
            allOperationInfos.forEach(info => {
                info.classList.add('collapsed');
            });
            
            allToggleIcons.forEach(icon => {
                icon.textContent = '‚ñ∂';
            });
            
            addLogEntry('info', 'All operations collapsed');
        }

        function goToTestFromOperation(operationPath, action) {
            // WebSocket Test ÏÑπÏÖòÏúºÎ°ú Ïä§ÌÅ¨Î°§
            const testSection = document.getElementById('websocket-test');
            testSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            if (action === 'send') {
                // SEND operationÏù∏ Í≤ΩÏö∞ Send Message Ìå®ÎÑêÏóêÏÑú Ìï¥Îãπ destination ÏÑ†ÌÉù
                if (apiSpec.operations && apiSpec.operations[operationPath]) {
                    const operationSpec = apiSpec.operations[operationPath];
                    const channelPath = getChannelPathFromRef(operationSpec.channel);
                    
                    const destinationSelect = document.getElementById('message-destination');
                    destinationSelect.value = channelPath;
                    
                    // Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏ Ìä∏Î¶¨Í±∞
                    createDestinationVariableInputs(channelPath);
                    loadExampleMessage(channelPath);
                    updateFinalDestination();
                    updateGoToOperationButton();
                    
                    // Send Message Ìå®ÎÑê ÌïòÏù¥ÎùºÏù¥Ìä∏
                    const messagePanel = document.querySelector('.message-panel');
                    messagePanel.style.boxShadow = '0 0 20px rgba(52, 152, 219, 0.6)';
                    setTimeout(() => {
                        messagePanel.style.boxShadow = '';
                    }, 2000);
                }
            } else if (action === 'receive') {
                // RECEIVE operationÏù∏ Í≤ΩÏö∞ Subscription Ìå®ÎÑêÏóêÏÑú Ìï¥Îãπ topic ÏÑ†ÌÉù
                if (apiSpec.operations && apiSpec.operations[operationPath]) {
                    const operationSpec = apiSpec.operations[operationPath];
                    const topicPath = getChannelPathFromRef(operationSpec.channel);
                    
                    const topicSelect = document.getElementById('subscription-topic');
                    topicSelect.value = topicPath;
                    
                    // Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏ Ìä∏Î¶¨Í±∞
                    createSubscriptionVariableInputs(topicPath);
                    updateFinalSubscription();
                    updateGoToTopicButton();
                    
                    // Subscription Ìå®ÎÑê ÌïòÏù¥ÎùºÏù¥Ìä∏
                    const subscriptionPanel = document.querySelector('.subscription-panel');
                    subscriptionPanel.style.boxShadow = '0 0 20px rgba(23, 162, 184, 0.6)';
                    setTimeout(() => {
                        subscriptionPanel.style.boxShadow = '';
                    }, 2000);
                }
            }
        }
    </script>
</body>
</html>
